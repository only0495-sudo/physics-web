<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ½åœå‹’æ•ˆæ‡‰æ¨¡æ“¬å™¨ (å®Œæ•´æ•™å­¸ç‰ˆ)</title>
    <style>
        :root {
            /* åŸºç¤é…è‰² */
            --bg-color: #f4f7f6;
            --panel-bg: #ffffff;
            --text-color: #333;
            --primary: #2c3e50;
            --canvas-bg: #ecf0f1;
            --border-color: #bdc3c7;
            
            /* ç‹€æ…‹é¡è‰²è®Šæ•¸ */
            --color-green: #2ecc71;  
            --color-blue: #3498db;   
            --color-purple: #8e44ad; 
            --color-red: #e74c3c;    
            --color-darkred: #c0392b;
        }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            transition: all 0.3s;
        }

        /* --- æ¨¡å¼åˆ‡æ›æŒ‰éˆ• --- */
        .mode-switch-container {
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
            background: var(--panel-bg);
            padding: 8px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .mode-btn {
            padding: 8px 24px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s;
            background: transparent;
            color: #7f8c8d;
        }
        .mode-btn.active { color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .mode-btn#btn-sound.active { background: var(--color-blue); }
        .mode-btn#btn-light.active { background: var(--color-green); color: white; }

        /* --- ä¸»å®¹å™¨ --- */
        .main-container {
            background: var(--panel-bg);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
            max-width: 1000px;
            width: 100%;
        }

        /* --- ç‹€æ…‹é¡¯ç¤ºåˆ— --- */
        .status-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 20px;
            min-height: 110px; /* å¢åŠ é«˜åº¦ä»¥å®¹ç´è§£é‡‹æ–‡å­— */
            padding: 10px 25px;
            border-radius: 12px;
            background: var(--canvas-bg);
            border: 3px solid var(--border-color);
            transition: all 0.3s;
        }

        .status-left {
            flex: 1.2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 300px;
        }

        .status-text-content { font-size: 1.2rem; font-weight: bold; color: #7f8c8d; margin-bottom: 5px;}
        
        /* ç‰©ç†è¨»è¨˜ (å°æ¨™ç±¤) */
        .status-note {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 8px;
            font-weight: normal;
            background: rgba(255,255,255,0.6);
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
            align-self: flex-start;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* --- ä¸­é–“ï¼šå…‰è­œå„€ (Light Mode) --- */
        .spectrum-wrapper {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
        }

        .spectrum-label { font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px; font-weight: bold; }

        .spectrum-bar-container {
            position: relative;
            width: 100%; height: 20px; border-radius: 10px;
            background: linear-gradient(90deg, #8b0000 0%, #ff0000 20%, #f1c40f 40%, #2ecc71 50%, #3498db 60%, #8e44ad 80%, #4b0082 100%);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); border: 1px solid rgba(0,0,0,0.1);
        }

        .spectrum-arrow {
            position: absolute; top: -6px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; 
            border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 10px solid #333;
            filter: drop-shadow(0 2px 2px rgba(255,255,255,0.8)); transition: left 0.2s ease-out;
        }
        
        .spectrum-ticks {
            display: flex; justify-content: space-between; width: 100%; margin-top: 2px; font-size: 0.75rem; color: #95a5a6;
        }

        /* --- ä¸­é–“ï¼šè²æ³¢åŸç†æ–‡å­—ç›’ (Sound Mode) --- */
        .sound-explanation-box {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: #ffffff;
            border-radius: 8px;
            padding: 10px 15px;
            border-left: 5px solid var(--color-blue);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 1rem;
            color: #555;
            line-height: 1.5;
        }
        .sound-exp-title {
            font-weight: bold; font-size: 0.9rem; color: #2c3e50; margin-bottom: 3px;
        }
        .highlight-exp { color: var(--color-red); font-weight: bold; }

        /* --- å³å´ï¼šé¡è‰²è§€æ¸¬çª— --- */
        .color-observer-box {
            flex: 0 0 140px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px; background: rgba(255,255,255,0.5); border-radius: 10px;
        }
        .color-label { font-size: 0.85rem; margin-bottom: 5px; opacity: 0.8; text-align: center;}
        .color-swatch {
            width: 45px; height: 45px; border-radius: 50%;
            background-color: #bdc3c7; border: 4px solid #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1); transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        /* å…¬å¼ */
        .math-inline {
            font-family: "Times New Roman", serif;
            font-size: 1.5rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.8);
            color: #333;
            padding: 4px 15px;
            border-radius: 50px;
            margin-top: 5px;
        }
        .fraction-inline { display: inline-flex; flex-direction: column; align-items: center; margin: 0 5px; font-size: 1.2rem; }
        .num-inline { border-bottom: 2px solid #000; padding: 0 2px; line-height: 1; width: 100%; text-align: center; }
        .den-inline { padding-top: 2px; line-height: 1; width: 100%; text-align: center; }
        
        /* ç®­é ­æ¨£å¼ */
        .arrow-up { font-weight: 900; letter-spacing: -2px; }
        .arrow-down { font-weight: 900; letter-spacing: -2px; }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .control-panel {
            display: flex; flex-wrap: wrap; gap: 20px;
            justify-content: center; align-items: center;
            margin-bottom: 25px; padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .btn-group { display: flex; gap: 5px; }

        button {
            padding: 8px 18px; font-size: 15px; cursor: pointer;
            border: none; border-radius: 6px; transition: all 0.2s; font-weight: bold; color: white;
        }
        button:active { transform: scale(0.95); }
        button.btn-left { background-color: #3498db; }
        button.btn-stop { background-color: #95a5a6; }
        button.btn-right { background-color: #e67e22; }
        button.active { box-shadow: inset 0 0 8px rgba(0,0,0,0.6); filter: brightness(1.1); border: 2px solid #fff; }
        button.btn-reset { background-color: #2c3e50; padding: 10px 20px; }
        button.btn-pause { background-color: #8e44ad; padding: 10px 20px; width: 110px;}

        /* --- è¦–è¦ºåŒ–å€åŸŸ --- */
        .viz-row { display: flex; gap: 15px; margin-bottom: 15px; align-items: stretch; }

        .sim-container, .graph-container, .bottom-sim-wrapper {
            position: relative;
            border: 3px solid var(--primary);
            border-radius: 10px; overflow: hidden; background-color: var(--canvas-bg); transition: border-color 0.3s;
        }
        .sim-container { flex: 2; }
        .graph-container { flex: 1; background-color: #fff; } 
        .bottom-row { display: flex; gap: 15px; }
        .bottom-sim-wrapper { flex: 2; }
        .bottom-placeholder { flex: 1; display: flex; align-items: center; justify-content: center; }

        canvas { display: block; width: 100%; height: 100%; }

        .canvas-label {
            position: absolute; left: 10px; background: rgba(255,255,255,0.95);
            padding: 5px 15px; border-radius: 0 0 8px 8px;
            font-size: 0.95rem; font-weight: bold; pointer-events: none; z-index: 10; color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .label-top { top: 0; border-top: 4px solid var(--color-red); }
        .label-graph { top: 0; right: 10px; left: auto; border-top: 4px solid #8e44ad; }
        .label-bottom { top: 0; border-top: 4px solid var(--color-green); }

        .legend { display: flex; justify-content: center; gap: 20px; font-size: 0.9rem; color: var(--text-color); opacity: 0.8; }
    </style>
</head>
<body>

<div class="mode-switch-container">
    <button class="mode-btn active" id="btn-sound" onclick="setMode('sound')">ğŸ”Š è²æ³¢æ¨¡å¼ (Sound)</button>
    <button class="mode-btn" id="btn-light" onclick="setMode('light')">âœ¨ å…‰æ³¢æ¨¡å¼ (Light)</button>
</div>

<div class="main-container">
    <div class="status-display" id="statusContainer">
        
        <div class="status-left">
            <div id="statusTextContent" class="status-text-content">ç‹€æ…‹ï¼šå…©è€…ç›¸å°éœæ­¢</div>
            <div id="statusFormulaContent"></div>
            <div id="statusNoteContent" class="status-note" style="display:none;"></div>
        </div>

        <div class="spectrum-wrapper" id="spectrumBox" style="display: none;">
            <div class="spectrum-label">å…‰è­œé »ç§» (Doppler Shift)</div>
            <div class="spectrum-bar-container">
                <div class="spectrum-arrow" id="spectrumArrow"></div>
            </div>
            <div class="spectrum-ticks">
                <span>â—€ ç´…ç§»</span>
                <span>è—ç§» â–¶</span>
            </div>
        </div>

        <div class="sound-explanation-box" id="soundExpBox" style="display: none;">
            <div class="sound-exp-title">ğŸ“ é »ç‡è®ŠåŒ–åŸå› ï¼š</div>
            <div id="soundExpText">ç›®å‰éœæ­¢ï¼Œæ³¢é•·èˆ‡æ³¢é€Ÿçš†ç„¡è®ŠåŒ–ã€‚</div>
        </div>

        <div class="color-observer-box" id="colorBoxContainer" style="display: none;">
            <div class="color-label">è§€å¯Ÿè€…çœ‹åˆ°çš„é¡è‰²</div>
            <div class="color-swatch" id="obsColorSwatch"></div>
        </div>
    </div>

    <div class="control-panel">
        <div class="btn-group">
            <span style="display:flex; align-items:center; margin-right:5px; font-weight:bold; color:var(--text-color);">ğŸ”´ æ³¢æº:</span>
            <button class="btn-left" id="s-left" onclick="updateSource('left')">â¬… å‘å·¦</button>
            <button class="btn-stop active" id="s-stop" onclick="updateSource('stop')">â¹ éœæ­¢</button>
            <button class="btn-right" id="s-right" onclick="updateSource('right')">å‘å³ â¡</button>
        </div>

        <div class="btn-group">
            <button class="btn-pause" id="btn-pause" onclick="togglePause()">â¸ æš«åœ</button>
            <button class="btn-reset" onclick="resetSimulation()">ğŸ”„ é‡ç½®</button>
        </div>

        <div class="btn-group">
            <span style="display:flex; align-items:center; margin-right:5px; font-weight:bold; color:var(--text-color);">ğŸŸ¢ è§€å¯Ÿè€…:</span>
            <button class="btn-left" id="o-left" onclick="updateObserver('left')">â¬… å‘å·¦</button>
            <button class="btn-stop active" id="o-stop" onclick="updateObserver('stop')">â¹ éœæ­¢</button>
            <button class="btn-right" id="o-right" onclick="updateObserver('right')">å‘å³ â¡</button>
        </div>
    </div>

    <div class="viz-row">
        <div class="sim-container" style="height: 250px;">
            <div class="canvas-label label-top" id="label-top-text">è²æ³¢æ¨¡æ“¬</div>
            <canvas id="topCanvas" width="600" height="250"></canvas>
        </div>
        <div class="graph-container" style="height: 250px;">
            <div class="canvas-label label-graph">é »ç‡-æ™‚é–“åœ– (f-t)</div>
            <canvas id="graphCanvas" width="300" height="250"></canvas>
        </div>
    </div>

    <div class="bottom-row">
        <div class="bottom-sim-wrapper" style="height: 250px;">
            <div class="canvas-label label-bottom">æ¨™æº–å°ç…§çµ„ (éœæ­¢)</div>
            <canvas id="bottomCanvas" width="600" height="250"></canvas>
        </div>
        <div class="bottom-placeholder">
            <div class="legend">
                <span>ğŸ”´ æ³¢æº</span>
                <span>ğŸŸ¢ è§€å¯Ÿè€…</span>
                <span id="wave-legend">ğŸ”µ è²æ³¢</span>
            </div>
        </div>
    </div>
</div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let currentMode = 'sound'; 
    let isPaused = false;

    // å®šç¾©é¡è‰²å¸¸æ•¸
    const COLORS = {
        green: '#2ecc71',
        blue: '#3498db',
        deepPurple: '#8e44ad',
        red: '#e74c3c',
        deepRed: '#8b0000'
    };

    const CONFIG = {
        waveSpeed: 1.5,
        moveSpeed: 0.25,
        frequency: 50,
        simWidth: 600,
        simHeight: 250,
        initSourceX: 600 * 0.2,
        initObserverX: 600 * 0.8
    };

    // --- æ¨¡å¼åˆ‡æ› ---
    function setMode(mode) {
        currentMode = mode;
        const btnSound = document.getElementById('btn-sound');
        const btnLight = document.getElementById('btn-light');
        const labelTop = document.getElementById('label-top-text');
        const waveLegend = document.getElementById('wave-legend');
        
        // å…ƒä»¶åˆ‡æ›
        const colorBox = document.getElementById('colorBoxContainer');
        const spectrumBox = document.getElementById('spectrumBox');
        const soundExpBox = document.getElementById('soundExpBox');

        const swatch = document.getElementById('obsColorSwatch');
        const simContainers = document.querySelectorAll('.sim-container, .bottom-sim-wrapper');

        if (mode === 'light') {
            btnSound.classList.remove('active');
            btnLight.classList.add('active');
            labelTop.innerText = "å…‰æ³¢æ¨¡æ“¬ (é è¨­ç¶ å…‰)";
            waveLegend.innerText = "ğŸŸ¢ å…‰æ³¢";
            
            // é¡¯ç¤ºå…‰æ³¢å°ˆç”¨ï¼Œéš±è—è²æ³¢å°ˆç”¨
            colorBox.style.display = 'flex';
            spectrumBox.style.display = 'flex'; 
            soundExpBox.style.display = 'none';

            swatch.style.backgroundColor = COLORS.green;
            swatch.style.boxShadow = `0 0 10px ${COLORS.green}`;
            simContainers.forEach(el => el.style.borderColor = COLORS.green);

        } else {
            btnSound.classList.add('active');
            btnLight.classList.remove('active');
            labelTop.innerText = "è²æ³¢æ¨¡æ“¬";
            waveLegend.innerText = "ğŸ”µ è²æ³¢";
            
            // é¡¯ç¤ºè²æ³¢å°ˆç”¨ï¼Œéš±è—å…‰æ³¢å°ˆç”¨
            colorBox.style.display = 'none';
            spectrumBox.style.display = 'none'; 
            soundExpBox.style.display = 'flex';

            simContainers.forEach(el => el.style.borderColor = '#2c3e50');
        }
        
        resetSimulation();
    }

    // --- æš«åœåŠŸèƒ½ ---
    function togglePause() {
        isPaused = !isPaused;
        const btn = document.getElementById('btn-pause');
        if (isPaused) {
            btn.innerText = "â–¶ ç¹¼çºŒ";
            btn.style.backgroundColor = "#27ae60"; 
        } else {
            btn.innerText = "â¸ æš«åœ";
            btn.style.backgroundColor = "#8e44ad"; 
        }
    }

    // --- æ³¢ (Wave) ---
    class Wave {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.radius = 0;
            this.opacity = 1;
        }

        evolve() {
            this.radius += CONFIG.waveSpeed;
            if (this.radius > 450) {
                this.opacity = Math.max(0, 1 - (this.radius - 450) / 100);
            }
        }

        draw(ctx) {
            if (this.opacity <= 0) return;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            
            if (currentMode === 'sound') {
                ctx.strokeStyle = `rgba(52, 152, 219, ${this.opacity})`;
                ctx.lineWidth = 1.5;
            } else {
                ctx.strokeStyle = `rgba(39, 174, 96, ${this.opacity})`; 
                ctx.lineWidth = 2;
            }
            ctx.stroke();
        }
    }

    // --- å ´æ™¯ (Scene) ---
    class Scene {
        constructor(canvasId, isInteractive) {
            this.canvas = document.getElementById(canvasId);
            this.ctx = this.canvas.getContext('2d');
            this.width = this.canvas.width;
            this.height = this.canvas.height;
            this.isInteractive = isInteractive;
            this.reset();
        }

        reset() {
            this.sourceX = CONFIG.initSourceX;
            this.sourceY = this.height / 2;
            this.observerX = CONFIG.initObserverX;
            this.observerY = this.height / 2;
            this.sourceV = 0;
            this.observerV = 0;
            this.waves = [];
            this.frameCounter = 0;
        }

        setVelocities(sV, oV) {
            if (!this.isInteractive) return;
            this.sourceV = sV;
            this.observerV = oV;
        }

        updatePhysics() {
            if (this.isInteractive) {
                this.sourceX += this.sourceV;
                this.observerX += this.observerV;
                
                const padding = 30;
                let needReset = false;
                if (this.sourceX < -padding || this.sourceX > this.width + padding) needReset = true;
                if (this.observerX < -padding || this.observerX > this.width + padding) needReset = true;
                if (needReset) { resetSimulation(); return; }
            }

            this.frameCounter++;
            if (this.frameCounter >= CONFIG.frequency) {
                this.waves.push(new Wave(this.sourceX, this.sourceY));
                this.frameCounter = 0;
            }

            for (let i = this.waves.length - 1; i >= 0; i--) {
                this.waves[i].evolve();
                if (this.waves[i].opacity <= 0) this.waves.splice(i, 1);
            }
        }

        draw() {
            this.ctx.clearRect(0, 0, this.width, this.height);
            for (let w of this.waves) w.draw(this.ctx);
            this.drawEntity(this.observerX, this.observerY, 'green', 'è§€å¯Ÿè€…');
            this.drawEntity(this.sourceX, this.sourceY, 'red', 'æ³¢æº');
        }

        drawEntity(x, y, color, label) {
            const ctx = this.ctx;
            ctx.beginPath();
            ctx.arc(x, y, 8, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = '#7f8c8d';
            ctx.font = "12px sans-serif";
            ctx.textAlign = "center";
            ctx.fillText(label, x, y + 25);
        }
    }

    // --- åœ–è¡¨é¡åˆ¥ ---
    class Graph {
        constructor(canvasId) {
            this.canvas = document.getElementById(canvasId);
            this.ctx = this.canvas.getContext('2d');
            this.width = this.canvas.width;
            this.height = this.canvas.height;
            this.data = [];
            this.maxDataPoints = 300;
            this.baselineY = this.height / 2;
        }

        reset() {
            this.data = [];
            for(let i=0; i<this.maxDataPoints; i++) this.data.push(1.0);
        }

        addData(factor) {
            this.data.push(factor);
            if (this.data.length > this.maxDataPoints) this.data.shift();
        }

        draw() {
            const ctx = this.ctx;
            ctx.clearRect(0, 0, this.width, this.height);
            
            ctx.strokeStyle = '#bdc3c7';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.setLineDash([5, 5]);
            ctx.moveTo(0, this.baselineY);
            ctx.lineTo(this.width, this.baselineY);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#95a5a6';
            ctx.font = '12px Arial';
            ctx.fillText("fâ‚€", 5, this.baselineY - 5);

            if (this.data.length < 2) return;

            ctx.beginPath();
            ctx.lineWidth = 3;
            ctx.lineJoin = 'round';
            
            const lastVal = this.data[this.data.length-1];
            const status = getStatusColorAndText(lastVal);
            ctx.strokeStyle = status.color;

            for (let i = 0; i < this.data.length; i++) {
                const x = (i / (this.maxDataPoints - 1)) * this.width;
                const val = this.data[i];
                const y = this.baselineY - (val - 1) * 200; 
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šç‹€æ…‹åˆ¤å®š ---
    function getStatusColorAndText(factor) {
        let result = { color: COLORS.green, text: "ç›¸å°éœæ­¢", type: "static", isExtreme: false };
        
        if (Math.abs(factor - 1.0) < 0.01) {
            result.color = (currentMode==='sound') ? '#7f8c8d' : COLORS.green;
            return result;
        }

        const isApproach = factor > 1.0;
        const isExtreme = factor > 1.25 || factor < 0.8;
        result.isExtreme = isExtreme;

        if (currentMode === 'light') {
            if (isApproach) {
                result.color = isExtreme ? COLORS.deepPurple : COLORS.blue;
                result.text = isExtreme ? "ç›¸å°åŠ‡çƒˆé è¿‘ (å¤§å¹…è—ç§»)" : "ç›¸å°é è¿‘ (è—ç§»)";
            } else {
                result.color = isExtreme ? COLORS.deepRed : COLORS.red;
                result.text = isExtreme ? "ç›¸å°åŠ‡çƒˆé é›¢ (å¤§å¹…ç´…ç§»)" : "ç›¸å°é é›¢ (ç´…ç§»)";
            }
        } else {
            // Sound
            if (isApproach) {
                result.color = COLORS.blue;
                result.text = isExtreme ? "ç›¸å°åŠ‡çƒˆé è¿‘ (é »ç‡å¤§å¹…è®Šé«˜)" : "ç›¸å°é è¿‘ (é »ç‡è®Šé«˜)";
            } else {
                result.color = COLORS.red;
                result.text = isExtreme ? "ç›¸å°åŠ‡çƒˆé é›¢ (é »ç‡å¤§å¹…è®Šä½)" : "ç›¸å°é é›¢ (é »ç‡è®Šä½)";
            }
        }
        
        result.type = isApproach ? "approach" : "recede";
        return result;
    }

    // --- åˆå§‹åŒ– ---
    const topScene = new Scene('topCanvas', true);
    const bottomScene = new Scene('bottomCanvas', false);
    const freqGraph = new Graph('graphCanvas');

    function animate() {
        if (!isPaused) {
            topScene.updatePhysics();
            bottomScene.updatePhysics();
            const factor = calculateFrequencyFactor();
            freqGraph.addData(factor);
            updateStatusDisplay(factor, topScene.sourceV, topScene.observerV);
        }
        topScene.draw();
        bottomScene.draw();
        freqGraph.draw();
        requestAnimationFrame(animate);
    }
    animate();

    function calculateFrequencyFactor() {
        const sX = topScene.sourceX;
        const oX = topScene.observerX;
        const sV = topScene.sourceV;
        const oV = topScene.observerV;
        const waveV = CONFIG.waveSpeed;

        if (sV === 0 && oV === 0) return 1.0;

        const direction = (oX >= sX) ? 1 : -1;
        const vs_proj = sV * direction;
        const vo_proj = oV * (-direction);
        const denominator = waveV - vs_proj;
        if (Math.abs(denominator) < 0.001) return 1.0;
        return (waveV + vo_proj) / denominator;
    }

    let sDir = 'stop', oDir = 'stop';
    function updateSource(dir) { sDir = dir; updateUI('s', dir); applyVelocities(); }
    function updateObserver(dir) { oDir = dir; updateUI('o', dir); applyVelocities(); }
    
    function resetSimulation() {
        topScene.reset(); freqGraph.reset();
        isPaused = false;
        document.getElementById('btn-pause').innerText = "â¸ æš«åœ";
        document.getElementById('btn-pause').style.backgroundColor = "#8e44ad";
        sDir = 'stop'; oDir = 'stop';
        updateUI('s', 'stop'); updateUI('o', 'stop');
        applyVelocities();
    }

    function updateUI(prefix, dir) {
        ['left', 'stop', 'right'].forEach(d => document.getElementById(`${prefix}-${d}`).classList.remove('active'));
        document.getElementById(`${prefix}-${dir}`).classList.add('active');
    }
    
    function applyVelocities() {
        let sV = 0, oV = 0;
        const v = CONFIG.moveSpeed;
        if (sDir === 'left') sV = -v; if (sDir === 'right') sV = v;
        if (oDir === 'left') oV = -v; if (oDir === 'right') oV = v;
        topScene.setVelocities(sV, oV);
    }

    // --- ç‹€æ…‹æ›´æ–° (UI) ---
    function updateStatusDisplay(factor, sV, oV) {
        const container = document.getElementById('statusContainer');
        const textDiv = document.getElementById('statusTextContent');
        const formulaDiv = document.getElementById('statusFormulaContent');
        const noteDiv = document.getElementById('statusNoteContent');
        const swatch = document.getElementById('obsColorSwatch');
        const arrow = document.getElementById('spectrumArrow');
        const soundExpBox = document.getElementById('soundExpText');
        const soundExpContainer = document.getElementById('soundExpBox');
        
        const status = getStatusColorAndText(factor);
        
        // 1. é‚Šæ¡†é¡è‰²
        container.style.borderColor = (currentMode === 'sound' && status.type === 'static') ? '#bdc3c7' : status.color;

        // 2. å…‰æ³¢æ¨¡å¼ UI
        if (currentMode === 'light') {
            swatch.style.backgroundColor = status.color;
            swatch.style.boxShadow = `0 0 20px ${status.color}`;
            let arrowPos = 50 + (factor - 1.0) * 120;
            if (arrowPos < 5) arrowPos = 5; if (arrowPos > 95) arrowPos = 95;
            arrow.style.left = arrowPos + '%';
        } 
        
        // 3. è²æ³¢æ¨¡å¼åŸç†æ–‡å­—æ›´æ–° (æ ¸å¿ƒæ–°å¢)
        if (currentMode === 'sound') {
            soundExpContainer.style.borderLeftColor = status.color;
            if (status.type === 'static') {
                soundExpBox.innerHTML = "ç›®å‰éœæ­¢ï¼Œæ³¢é•·èˆ‡æ³¢é€Ÿçš†ç„¡è®ŠåŒ–ã€‚";
            } else {
                let explanations = [];
                // åˆ¤æ–·æ³¢æºç§»å‹•
                if (sV !== 0) {
                    if (status.type === 'approach') explanations.push("æ³¢æºè¿½è¶•æ³¢å‰ â¡ <span class='highlight-exp'>æ³¢é•·å£“ç¸® (Î»â†“)</span>");
                    else explanations.push("æ³¢æºé é›¢æ³¢å‰ â¡ <span class='highlight-exp'>æ³¢é•·æ‹‰ä¼¸ (Î»â†‘)</span>");
                }
                // åˆ¤æ–·è§€å¯Ÿè€…ç§»å‹•
                if (oV !== 0) {
                    if (status.type === 'approach') explanations.push("è§€å¯Ÿè€…è¿å‘è²æ³¢ â¡ <span class='highlight-exp'>ç›¸å°æ³¢é€Ÿè®Šå¿« (v'â†‘)</span>");
                    else explanations.push("è§€å¯Ÿè€…é€ƒé›¢è²æ³¢ â¡ <span class='highlight-exp'>ç›¸å°æ³¢é€Ÿè®Šæ…¢ (v'â†“)</span>");
                }
                soundExpBox.innerHTML = explanations.join("<br>");
            }
        }

        // 4. æ–‡å­—èˆ‡è¨»è¨˜
        let mainTextColor = (currentMode === 'sound' && status.type === 'static') ? '#7f8c8d' : status.color;
        textDiv.innerHTML = `<span style="color:${mainTextColor};">${status.text}</span>`;
        
        // è¨»è¨˜é¡¯ç¤º
        noteDiv.style.display = "inline-block";
        if (currentMode === 'light') {
            noteDiv.innerText = "ğŸ’¡ å…‰é€Ÿ c æ†å®šä¸è®Š";
        } else {
            noteDiv.innerText = "ğŸ”Š è²æ³¢æ³¢é€Ÿç‚ºç›¸å°é€Ÿåº¦ (v')";
        }
        if (status.type === 'static') noteDiv.style.display = 'none';

        // 5. å…¬å¼é‚è¼¯
        let upArrow = status.isExtreme ? "â†‘â†‘" : "â†‘";
        let downArrow = status.isExtreme ? "â†“â†“" : "â†“";

        if (status.type === 'static') {
            formulaDiv.innerHTML = `<span style="font-weight:normal; font-size:1rem; color:#999;">(ç„¡é »ç‡è®ŠåŒ–)</span>`;
            return;
        }

        let f_arrow = (status.type === 'approach') 
            ? `<span class="arrow-up" style="color:${status.color}">${upArrow}</span>` 
            : `<span class="arrow-down" style="color:${status.color}">${downArrow}</span>`;

        let v_part = "", lambda_part = "";

        if (currentMode === 'light') {
            v_part = "c"; 
            let lambdaArrowSign = (status.type === 'approach') ? downArrow : upArrow;
            lambda_part = `Î» <span class="arrow-down" style="color:${status.color}">${lambdaArrowSign}</span>`;
        } else {
            // Sound: åˆ†å­ v è®Š (è‹¥è§€å¯Ÿè€…å‹•), åˆ†æ¯ Î» è®Š (è‹¥æ³¢æºå‹•)
            let vArrowSign = (status.type === 'approach') ? upArrow : downArrow;
            let lambdaArrowSign = (status.type === 'approach') ? downArrow : upArrow;

            if (oV !== 0) {
                v_part = `v <span class="arrow-up" style="color:${status.color}">${vArrowSign}</span>`;
            } else {
                v_part = "v";
            }

            if (sV !== 0) {
                lambda_part = `Î» <span class="arrow-down" style="color:${status.color}">${lambdaArrowSign}</span>`;
            } else {
                lambda_part = "Î»";
            }
        }

        formulaDiv.innerHTML = `
            <div class="math-inline">
                f ${f_arrow} = 
                <div class="fraction-inline">
                    <span class="num-inline">${v_part}</span>
                    <span class="den-inline">${lambda_part}</span>
                </div>
            </div>`;
    }
</script>
</body>
</html>